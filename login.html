<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
        <meta http-equiv="page-Enter" content="revealTrans(Duration=3.0,Transition=23)">
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
		<link rel="stylesheet" type="text/css" href="lib/layui/css/layui.css"/>
		<link rel="stylesheet" type="text/css" href="lib/font-awesome/css/font-awesome.css"/>
		<title>人民新时代党建</title>
		<style type="text/css">
			.loginForm{
				height: 95% !important;
			}
			.logo{
				width: 70%;
				margin: auto;
			}
		</style>
	</head>
	<body>
		<!-- 进入页面 -->
		<div class="topNavBar"></div>
		<div class="mainBody" id="app" v-cloak>
			<div class="loginBox">
				<div class="loginImg"></div>
				<div class="loginForm" v-show="forgetPwd == false">
					<div class="forgetPwd">登录</div>
					<div class="formItem">
						<p>账号</p>
						<p><input v-model="form.username" type="text" name="" id="" value="" /></p>
					</div>
					<div class="formItem">
						<p>密码</p>
						<p><input v-model="form.password" type="password" name="" id="" value="" /></p>
					</div>
					<div class="controlLogin">
						<p @click="savePassword"><span><i v-show="savePwd" class="fa fa-check" aria-hidden="true"></i></span>记住账号</p>
						<p @click="forgetPassword">忘记密码</p>
					</div>
					<div class="loginbtn" @click="login">{{logining}}</div>
				</div>
				<!-- 忘记密码 -->
				<div class="loginForm" v-show="forgetPwd == true">
					<div class="logo"><img src="statics/images/sxlogo.png" ></div>
					<div class="forgetPwd">找回密码</div>
					<div class="formItem" style="margin-top: 2vh;">
						<p>手机号</p>
						<p><input type="number" maxlength="11" οninput="if(value.length>11) value=value.slice(0,11)" placeholder="请输入负责人手机号" v-model="find.phone" type="text" name="" id="" value="" /></p>
					</div>
					<div class="formItem" style="margin-top: 2vh;">
						<p>验证码</p>
						<p class="phoneCode">
							<input type="number" maxlength="6" οninput="if(value.length>6)value=value.slice(0,6)"  placeholder="请输入验证码" v-model="find.code" name="" id="" value="" />
							<span :class="getcodeStatus == true?'noClick':''" @click="getCode">
								<span v-show="getcodeStatus == true">
									<span>{{second}}</span>秒
								</span>
								{{getCodeText}}
							</sapn>
						</p>
					</div>
					<div class="formItem" style="margin-top: 2vh;">
						<p>重置密码</p>
						<p><input v-model="find.pwd" type="password" name="" id="" value="" /></p>
					</div>
					<div class="loginbtn" style="margin-top: 5.5vh;" @click="upatePwd">确定修改</div>
					<div class="register" @click="cancelUpatePwd">取消</div>
				</div>
			</div>
			<div class="tishiWords">版权内容为人民视讯所有，未经授权禁止转售</div>
		</div>
		<script src="lib/jquery/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/setCookie.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/ajax.js" type="text/javascript" charset="utf-8"></script>
		<script src="lib/layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			window.onload = function(){
				var app = new Vue({
					el:'#app',
					data:{
						// 是否记住密码
						savePwd:false,
						// 登录账户
						form:{
							username:"",
							password:""
						},
						// 找回密码
						find:{
							phone:"",
							code:"",
							pwd:""
						},
						second:180,
						// 忘记密码
						forgetPwd:false,
						// 获取验证码
						getCodeText:"获取验证码",
						// 获取验证码状态
						getcodeStatus:false,
						logining:"登录"
					},
					methods:{
						// 记住密码
						savePassword(){
							var that = this;
							if(that.form.username == "" || that.form.password == ""){
								layer.msg("请输入账户或密码",{anim:6,time:600})
							}else{
								that.savePwd = !that.savePwd;
								if(that.savePwd == true){
									$.cookie('userInfo1', JSON.stringify(that.form), {expires: 15});
								}else{
									// 判断是否有cookie
									if($.cookie('userInfo1') != "undefined" && $.cookie('userInfo1') != null){
										$.cookie('userInfo1',"",-1);
									}
								}
							}
						},
						// 忘记密码
						forgetPassword(){
							var that = this;
							that.forgetPwd = true;
						},
						// 登录
						login(){
							var that = this;
							if(that.form.username == ""){
								layer.msg("请输入账号",{anim:6,time:600})
							}else if(that.form.password == ""){
								layer.msg("请输入密码",{anim:6,time:600})
							}else{
								postData("login",that.form,function(res){
									if(res.code == 200){
										res.data.password = that.form.password;
										$.cookie('userInfo', JSON.stringify(res.data), {expires: 15});
										window.location.href = 'app.html?date='+new Date().getTime()
									}else{
										layer.msg(res.msg,{anim:6,time:600})
									}
								})
							}
						},
						// 修改密码
						upatePwd(){
							var that = this;
							if(that.find.phone == ""){
								layer.msg("请输入手机号",{anim:6,time:600})
							}else if(that.find.code == ""){
								layer.msg("请输入验证码",{anim:6,time:600})
							}else if(that.find.pwd == ""){
								layer.msg("请输入密码",{anim:6,time:600})
							}else{
								postData("forgetPwd",that.find,function(res){
									if(res.code == 200){
										layer.msg("修改成功请返回登录",{time:600},function(){
											that.forgetPwd = false;
										})
									}else{
										layer.msg("请输入密码",{anim:6,time:600})
									}
								})
							}
						},
						// 获取验证码
						getCode(){
							var that = this;
							if(that.find.phone == ""){
								layer.msg("请输入手机号",{anim:6,time:600})
							}else{
								postData("send_phone",{phone:that.find.phone},function(res){
									if(res){
										that.getcodeStatus = true;
										that.getCodeText = "后重新获取"
										var time = setInterval(function(){
											if(that.second == 1){
												that.second = 180;
												clearInterval(time)
												that.getcodeStatus = false;;
											}else{
												that.second--
											}
										},1000);
									}
									
								})
							}
						},
						// 取消修改密码
						cancelUpatePwd(){
							var that = this;
							that.find = {
								username:"",
								code:"",
								password:""
							}
							that.forgetPwd = false
						},
					},
					mounted() {
						var that = this;
						// 判断cookie是否存在
						if($.cookie('userInfo') != "null"){
							var form = JSON.parse($.cookie('userInfo'));
							console.log(form)
							that.form = form;
							that.savePwd = true;
							that.logining = "正在登录..."
							that.login();
						}else if($.cookie('userInfo1') != "null"){
							var form = JSON.parse($.cookie('userInfo1'));
							that.form = form;
							that.savePwd = true;
						}else{
							that.form = {
								username:"",
								password:""
							};
						}
					},
					created() {
						var that = this;
						// 初始化layui框架
						layui.use('layer',function(){
							var layer = layui.layer
						});
						// 回车登录
						$(document).keydown(function(event){
							if(event.keyCode == 13){
								that.login();
							}
						})
					}
				})
			}
		</script>
	</body>
</html>
